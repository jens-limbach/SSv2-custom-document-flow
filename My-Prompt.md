# The Perfect Prompt: Document Flow Application

## My Original Prompt - From Concept to Code

I first asked the AI to provide me a prompt for generating a doc flow for Angular similar to the UI5 process flow component. This is the prompt I got:

---

### Initial AI-Generated Prompt

Act as a Senior Angular Developer and SAP Fiori UI expert.

I need a custom "Document Flow" component that visually mimics the SAPUI5 ProcessFlow, but built natively in Angular.

**Technical Stack:**
1.  **Framework:** Angular (Standalone Component).
2.  **Graph Engine:** `@swimlane/ngx-graph` (used for layout and arrow rendering).
3.  **UI Components:** `@fundamental-ngx/core` (specifically `fd-card`, `fd-icon`, or `fd-status-indicator` for the node visuals).
4.  **Theme:** SAP Horizon (simulate this using CSS variables if actual generic styles aren't available).

**Requirements:**
1.  **Layout:** Use a directed acyclic graph (DAG) layout (Left-to-Right direction).
2.  **Nodes (Crucial):**
    * Do NOT use the default graph circles.
    * Use an `ng-template` for the nodes to render a custom Fiori-styled box.
    * Each node should look like a small Fiori card or Object Status. It must have an icon, a title (e.g., "Sales Order"), and a status color (Success/Green, Warning/Orange, Error/Red).
3.  **Links:** Use smooth curved lines (`curveBundle` or similar) that look professional and minimal.
4.  **Data:** Create a mock dataset representing a standard document flow:
    * Node 1: "Sales Order" (Status: Success)
    * Node 2: "Outbound Delivery" (Status: Warning) -> Connected from Node 1
    * Node 3: "Invoice" (Status: Success) -> Connected from Node 2
    * Node 4: "Accounting Doc" (Status: Error) -> Connected from Node 3

**Output:**
* Provide the TypeScript code for the Standalone Component (`imports`, `nodes`, `links`, `layout` settings).
* Provide the HTML Template using `<ngx-graph>` with the `<ng-template #defs>` and `<ng-template #nodeTemplate>`.
* Provide the SCSS to style the graph container and ensure the nodes have the correct "SAP Horizon" shadow, rounded corners, and font.

Please ensure the code is production-ready and handles the graph dimensions responsively.

**Pre-requisites for this Prompt**

For the code generated by this prompt to work, you will need to install the graph library and its dependencies (D3) in your project first:
```bash
npm install @swimlane/ngx-graph @swimlane/ngx-charts d3-shape d3-selection
```

---

### My Extensions to the Initial Prompt

#### Menu on each node

Also I need a small menu (like a burger menu) in the top right corner of each node / box. This menu should have two options: "Open List View" and "+ Create".

These two buttons require the same function as the above one for the Quick View. The only difference is that both do not require a `objectKey` and the `viewType` is "list" for the open list view and the `viewType` for the create is "quickcreate".

#### Legend

Add a simple legend that explains the color coding of the nodes.

#### Optional extension of the graph

I want a clickable icon for extending the flow even more behind each node that has more objects linked to it. In order to find out if a node has more documents linked, you need to do the same api call for each node at the right end of the graph. You need to take care that you provide to the API the correct `objectDisplayId` and also `ObjectType`. If you can find more linked objects that would lead to extend the graph, don't show them yet but memorize them. If the user clicks then on the icon you show this extended part behind that particular node. The icon should only show if there are more objects linked. The icon should be positioned on the left hand side of the nodes and symbolize that an extension could be possible.

#### Navigation to CRM objects

The user should be able to click on each ID value of each box in order to open the so called "quick view". Add an onClick handler which triggers the following function.

Example for serviceCaseId:
```javascript
onclick='openNewCnsCaseViewWithRoutingKey();'

// Open specific Case
function openNewCnsCaseViewWithRoutingKey() {
    var oCase = {
        operation: "navigation", 
        params: {
            objectKey: "45413257-b7bc-11ef-aee8-63f1e786c385", 
            routingKey: "case", 
            viewType: "quickview"
        }
    };
    window.parent.postMessage(oCase, '*')
}
```

Replace the UUID given in the `objectKey` with the actual UUID of each entity (`objectId`).

Here are the routing keys for the different objects in the format `object : routingKey`:
-	Survey : survey
-	Opportunity : guidedselling
-	Quote : sales-quote
-	Lead : lead
-	Phone Call : phone
-	Task : task
-	Visit : visit
-	Case : case

#### Data and API Setup

The UI will be embedded in another UI as an iFrame and always be initiated with two url parameters. The `sourceid=58a9dd18-cf47-11f0-9209-e5c3caa18d2f` represents always the UUID of the "current" object and the `sourcetype=72` which represents the type of object but is hardcoded for the moment.

With those parameters you can call the API of the CRM which has a table for the "related objects" to the "current object". With this information you can build the document flow to be visualized. Here is the api details:

**API Configuration:**
- Hostname: `https://YOUR-SAP-C4C-HOST.demo.crm.cloud.sap`
- Path: `/sap/c4c/api/v1/document-flow-service/relatedObjects`
- Authentication: Basic Auth (configured in environment files)

An example of the endpoint to be called with parameters is the following: 
```
https://YOUR-SAP-C4C-HOST.demo.crm.cloud.sap/sap/c4c/api/v1/document-flow-service/relatedObjects?$sourceid=58a9dd18-cf47-11f0-9209-e5c3caa18d2f&$sourcetype=72
```

This is an example payload of the system for the document flow of the opportunity as the "current object".

You have in the first two entries the `objectDisplayId` with the opportunity 527 with the `objectType` 72 which means opportunity.

The first entry has the `relatedObjectDisplayId` 261 of type 30 which means Quote
The second entry has the `relatedObjectDisplayId` 296 of type 12 which means Appointment

The third entry has the `objectDisplayId` 878 and the `objectType` 64 which means Lead and relates to the `relatedObjectDisplayId` 527 with the `objectType` 72 which means Opportunity.

When you put this all together you will have a graph from the Lead to the Opportunity to a Quote and an Appointment (those are both linked to the Opportunity).

There are more `objectType` codes for other objects which can appear in the document flow:
-	Survey
-	Phone Call: 86
-	Task: 542
-	Sales Order: 2059
-	Visit: 2054
-	Case: 2886

**Payload example for above described example:**
```json
{
    "value": [
        {
            "id": "64dd568f-cf47-11f0-94ab-4b5c283fa5c3",
            "objectId": "58a9dd18-cf47-11f0-9209-e5c3caa18d2f",
            "objectDisplayId": "527",
            "objectType": "72",
            "role": "SUCCESSOR",
            "relatedObjectType": "30",
            "relatedObjectId": "38bf8e39-f9a4-4956-af04-b108f5c99832",
            "relatedObjectDisplayId": "261",
            "adminData": {
                "createdBy": "b8adfb7e-50f3-11f0-a28d-fd9b4de46c56",
                "createdOn": "2025-12-02T06:23:18.858Z",
                "updatedBy": "00000000-0000-0000-0000-000000000000",
                "updatedOn": "2025-12-02T06:23:19.034Z"
            }
        },
        {
            "id": "60e037c4-cf47-11f0-ba3b-3ba67f843dd2",
            "objectId": "58a9dd18-cf47-11f0-9209-e5c3caa18d2f",
            "objectDisplayId": "527",
            "objectType": "72",
            "role": "SUCCESSOR",
            "relatedObjectType": "12",
            "relatedObjectId": "5f67c87e-cf47-11f0-a622-01171b91ada1",
            "relatedObjectDisplayId": "296",
            "adminData": {
                "createdBy": "b8adfb7e-50f3-11f0-a28d-fd9b4de46c56",
                "createdOn": "2025-12-02T06:23:12.312Z",
                "updatedBy": "b8adfb7e-50f3-11f0-a28d-fd9b4de46c56",
                "updatedOn": "2025-12-02T06:23:12.342Z"
            }
        },
        {
            "id": "5a621463-cf47-11f0-94ab-37592ae913f6",
            "objectId": "4b2fb255-cf47-11f0-a2c0-a5ef8d7c8eec",
            "objectDisplayId": "878",
            "objectType": "64",
            "role": "SUCCESSOR",
            "relatedObjectType": "72",
            "relatedObjectId": "58a9dd18-cf47-11f0-9209-e5c3caa18d2f",
            "relatedObjectDisplayId": "527",
            "adminData": {
                "createdBy": "b8adfb7e-50f3-11f0-a28d-fd9b4de46c56",
                "createdOn": "2025-12-02T06:23:01.006Z",
                "updatedBy": "00000000-0000-0000-0000-000000000000",
                "updatedOn": "2025-12-02T06:23:01.449Z"
            }
        }
    ]
}
```

---

## Additional Technical Implementation Details

### 1. Visual Graph Display
- Display business objects as connected nodes in a horizontal flow (left to right)
- Each node should be a card showing:
  - The object type name (e.g., "Opportunity", "Sales Order")
  - The object's ID number
  - An appropriate icon for the object type
  - Color-coded borders indicating status (green for success, orange for warning, red for error, gray for neutral)
- Arrows should connect nodes to show relationships between objects
- Users should be able to zoom, pan, and drag the graph around to explore the data

### 2. Data Integration
- Fetch real-time data from the SAP C4C REST API:
  - **Endpoint**: `https://YOUR-SAP-C4C-HOST.demo.crm.cloud.sap/sap/c4c/api/v1/document-flow-service/relatedObjects`
  - **Authentication**: Basic Auth (configured in environment files)
  - **Parameters**: Accept `sourceid` (UUID of the object) and `sourcetype` (object type code) from the URL
- If no parameters are provided, show mock data for demonstration purposes

---

## Additional Technical Implementation Details

Below are the detailed implementation patterns that emerged while building this application with AI assistance. These can guide you or an AI assistant in creating a production-ready solution.

### Visual Graph Display

**Layout Configuration:**
- Use `@swimlane/ngx-graph` with `dagre` layout
- Set orientation to 'LR' (left-to-right)
- Node dimensions: 160px width √ó 100px height
- Disable node dragging for stability: `[draggingEnabled]="false"`
- Enable zoom and pan for navigation

**Node Rendering:**
Each node should be rendered using a custom `ng-template` with the following structure:

```html
<ng-template #nodeTemplate let-node>
  <svg:foreignObject [attr.width]="nodeWidth" [attr.height]="nodeHeight">
    <xhtml:div class="custom-node" [class.current-node]="node.isCurrent">
      <!-- Expand Icon (if hasMoreRelations) -->
      <!-- Overflow Menu (three dots) -->
      <!-- Node Icon -->
      <!-- Node Content (title and clickable ID) -->
      <!-- Status Indicator -->
    </xhtml:div>
  </svg:foreignObject>
</ng-template>
```

**Current Object Indicator:**
- Add a 12px thick left border to highlight the current object
- Use `--sap-content-icon-color` for the border color
- Adjust padding to maintain content alignment

### Node Interactions

#### A. Per-Node Overflow Menu (Three-Dot Menu)
Each node card must have an **overflow menu icon (three dots)** in the **top-right corner** of the card. When clicked, it should display a dropdown menu with two options:

**Menu Structure:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìã Open List View   ‚îÇ
‚îÇ ‚ûï + Create         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Implementation Details:**

1. **Menu Toggle Function:**
```typescript
toggleMenu(event: Event, nodeId: string): void {
  event.stopPropagation();
  this.openMenuId = this.openMenuId === nodeId ? null : nodeId;
}

isMenuOpen(nodeId: string): boolean {
  return this.openMenuId === nodeId;
}
```

2. **Open List View Function:**
When "Open List View" is clicked, send a postMessage to the parent window to open the list view for that object type:
```typescript
openListView(event: Event, node: DocumentNode): void {
  event.stopPropagation();
  this.openMenuId = null;
  
  const routingKey = ROUTING_KEY_MAPPING[node.objectType];
  
  if (!routingKey) {
    console.error('No routing key found for object type:', node.objectType);
    return;
  }

  console.log('Opening list view:', { routingKey });
  
  const message = {
    operation: 'navigation',
    params: {
      routingKey: routingKey,
      viewType: 'list'
    }
  };
  
  window.parent.postMessage(message, '*');
}
```

3. **+ Create (Quick Create) Function:**
When "+ Create" is clicked, send a postMessage to open the quick create view for that object type:
```typescript
openQuickCreate(event: Event, node: DocumentNode): void {
  event.stopPropagation();
  this.openMenuId = null;
  
  const routingKey = ROUTING_KEY_MAPPING[node.objectType];
  
  if (!routingKey) {
    console.error('No routing key found for object type:', node.objectType);
    return;
  }

  console.log('Opening quick create:', { routingKey });
  
  const message = {
    operation: 'navigation',
    params: {
      routingKey: routingKey,
      viewType: 'quickcreate'
    }
  };
  
  window.parent.postMessage(message, '*');
}
```

#### B. Clickable Object ID (Quick View)
The object's display ID (e.g., "527" for an Opportunity) should be clickable. When clicked, it should open the **quick view** for that specific object:

```typescript
onIdClick(event: Event, node: DocumentNode): void {
  event.stopPropagation(); // Prevent node click event
  this.openQuickView(node.objectId, node.objectType);
}

private openQuickView(objectId: string, objectType: string): void {
  const routingKey = ROUTING_KEY_MAPPING[objectType];
  
  if (!routingKey) {
    console.error('No routing key found for object type:', objectType);
    return;
  }

  console.log('Opening quickview:', { objectId, routingKey });
  
  const message = {
    operation: 'navigation',
    params: {
      objectKey: objectId,
      routingKey: routingKey,
      viewType: 'quickview'
    }
  };
  
  window.parent.postMessage(message, '*');
}
```

#### C. Routing Key Mapping (Critical for SAP C4C Integration)
You must create a mapping between SAP object type codes and their corresponding routing keys for navigation:

```typescript
export const ROUTING_KEY_MAPPING: { [key: string]: string } = {
  '12': 'appointment',
  '30': 'sales-quote',
  '64': 'lead',
  '72': 'guidedselling',      // Opportunity
  '80': 'sales-order',
  '86': 'phone',
  '90': 'delivery',
  '100': 'invoice',
  '110': 'accounting',
  '542': 'task',
  '2054': 'visit',
  '2059': 'sales-order',
  '2886': 'case',
};
```

#### D. PostMessage Protocol Summary
All interactions with the parent SAP C4C window use this postMessage format:

**Quick View (when clicking object ID):**
```javascript
{
  operation: 'navigation',
  params: {
    objectKey: 'uuid-of-specific-object',
    routingKey: 'guidedselling',  // From mapping
    viewType: 'quickview'
  }
}
```

**List View (from overflow menu):**
```javascript
{
  operation: 'navigation',
  params: {
    routingKey: 'sales-order',  // From mapping
    viewType: 'list'
  }
}
```

**Quick Create (from overflow menu):**
```javascript
{
  operation: 'navigation',
  params: {
    routingKey: 'sales-quote',  // From mapping
    viewType: 'quickcreate'
  }
}
```

#### E. Visual Requirements for Node Card
Each node card HTML structure should look like this:
```html
<div class="custom-node">
  <!-- Overflow Menu (Top Right) -->
  <div class="node-menu">
    <fd-icon glyph="overflow" class="menu-icon" (click)="toggleMenu($event, node.id)"></fd-icon>
    <div class="menu-dropdown" [class.show]="isMenuOpen(node.id)">
      <div class="menu-item" (click)="openListView($event, node)">
        <fd-icon glyph="list"></fd-icon>
        <span>Open List View</span>
      </div>
      <div class="menu-item" (click)="openQuickCreate($event, node)">
        <fd-icon glyph="add"></fd-icon>
        <span>+ Create</span>
      </div>
    </div>
  </div>

  <!-- Icon -->
  <div class="node-icon-wrapper">
    <fd-icon [glyph]="node.icon" class="node-icon"></fd-icon>
  </div>

  <!-- Content -->
  <div class="node-content">
    <div class="node-title">{{ node.label }}</div>
    <div class="node-subtitle">
      <fd-icon glyph="tag" class="subtitle-icon"></fd-icon>
      <span class="object-id-link" (click)="onIdClick($event, node)">
        {{ node.objectDisplayId }}
      </span>
    </div>
  </div>

  <!-- Status Indicator -->
  <div class="status-indicator" [style.background-color]="getStatusColor(node.status)"></div>
</div>
```

**Important Notes:**
- All click handlers must call `event.stopPropagation()` to prevent triggering node click events
- The overflow menu should close when any menu item is clicked
- Only one menu can be open at a time (tracked by `openMenuId` state)
- The object ID link should be styled to look clickable (underline, pointer cursor)

### 4. Object Type Support
Support these SAP C4C object types with appropriate icons and colors:
- Appointment (12) - appointment icon
- Quote (30) - sales-quote icon  
- Lead (64) - leads icon
- Opportunity (72) - opportunity icon
- Sales Order (80) - sales-order icon
- Outbound Delivery (90) - shipping-status icon
- Invoice (100) - document icon
- Accounting Document (110) - account icon
- Phone Call (126) - phone icon
- Task (128) - task icon
- Email (130) - email icon
- Service Request (140) - customer-and-supplier icon
- Ticket (150) - cart icon

### 5. Design & Styling
- Use **SAP Horizon theme** (modern SAP Fiori design)
- Style should match SAP's current design language with:
  - Clean, professional cards for nodes
  - Proper spacing and typography
  - SAP UI5 icon fonts
  - SAP color palette (green for success, orange for warning, etc.)
- Application should be responsive and work on desktop, tablet, and mobile

### 6. Deployment
- Must be deployable to **Cloud Foundry** as a static web application
- Keep the deployment package small (under 64MB disk quota)
- Use HTTPS in production

## Technical Constraints

### Framework & Libraries
- Build with **Angular** (latest version, use standalone components)
- Use **@swimlane/ngx-graph** for the graph visualization with dagre layout
- Use **@fundamental-ngx/core** for SAP Fiori-styled UI components
- Load **SAP UI5 icon fonts** from CDN

### Architecture
- Single Page Application (SPA) with Angular routing
- Standalone components (no NgModule)
- Service-based architecture for API calls
- Model files for type definitions and mappings

### Key Behaviors
- The graph arrows must work correctly with zoom, pan, and drag - they should move dynamically with the graph transformations
- Use native ngx-graph capabilities rather than custom DOM manipulation to ensure transformations work properly
- Enable animations for smooth interactions

## Integration Details

### URL Parameters
The application should read URL parameters to determine what to display:
```
/document-flow?sourceid=58a9dd18-cf47-11f0-9209-e5c3caa18d2f&sourcetype=72
```

### iFrame Embedding
The application will be embedded in SAP C4C using an iFrame, so:
- Support postMessage communication with the parent window
- Accept parameters via URL
- Work within iFrame security constraints

### API Response Format
The SAP C4C API returns data in this structure:
```json
{
  "value": [
    {
      "objectId": "source-uuid",
      "objectDisplayId": "527",
      "objectType": "72",
      "relatedObjectId": "target-uuid",
      "relatedObjectDisplayId": "261",
      "relatedObjectType": "30",
      "role": "SUCCESSOR"
    }
  ]
}
```

Transform this into a graph with nodes and edges.

## Success Criteria

1. ‚úÖ Graph displays correctly with all nodes and connections
2. ‚úÖ Users can zoom, pan, and drag nodes - arrows move correctly with all transformations
3. ‚úÖ Data loads from the real SAP C4C API when parameters are provided
4. ‚úÖ Object ID clicks send postMessage to parent window
5. ‚úÖ Visual design matches SAP Horizon theme
6. ‚úÖ All 13 object types display with correct icons and colors
7. ‚úÖ Application deploys successfully to Cloud Foundry
8. ‚úÖ Works in iFrame embedded in SAP C4C
9. ‚úÖ Responsive design works on all screen sizes
10. ‚úÖ Loading states and error handling are user-friendly

## Non-Functional Requirements

- **Performance**: Handle graphs with up to 50 nodes smoothly
- **Browser Support**: Chrome, Firefox, Safari, Edge (latest versions)
- **Security**: Use HTTPS, handle authentication securely
- **Maintainability**: Clean, well-structured code with proper separation of concerns
- **Documentation**: Comprehensive README with setup, deployment, and usage instructions

## What NOT to Do

- Don't use complex custom arrow positioning that breaks zoom/pan/drag functionality
- Don't manually manipulate SVG DOM elements for transformations - let the graph library handle it
- Don't create tight coupling between components
- Don't hardcode API credentials in the code (use environment variables or configuration files in production)
- Don't overcomplicate the graph rendering - use library defaults where possible

---

**Expected Deliverables:**
1. Complete Angular application with all source code
2. Cloud Foundry deployment configuration (manifest.yml)
3. Comprehensive README documentation
4. Working deployment to Cloud Foundry
5. All 13 object types properly configured with icons and colors
6. Functional burger menu navigation
7. Working postMessage integration for object ID clicks
